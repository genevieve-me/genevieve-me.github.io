<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Genevieve Mendoza</title>
        <link rel="stylesheet" href="/main.css" />
    </head>

    <body>
        <!-- is this bad? "Practically speaking this means you have to choose between using includes or extends to organise your site, without mixing them."  -->
        <header id="header_bar">
    <div class="header-div">
        <!-- checkbox stores the state of the dropdown navbar for mobile -->
        <input type="checkbox" id="nav-toggle" class="nav-toggle" />
        <div class="header-brand">
            <a title="Go to home page" href="/" class="text-2xl font-semibold"
                >home</a
            >
            <!-- hamburger button used for the navbar checkbox hack -->
            <label for="nav-toggle" class="nav-toggle-label">
                <span></span>
                <span></span>
                <span></span>
            </label>
        </div>
        <nav class="nav-container">
            <menu class="nav-wrapper">
                <li>
                    <a
                        class="primary-link"
                        href="https://www.genevievemendoza.com/blog/"
                        >blog</a
                    >
                </li>
                <li>
                    <a
                        class="primary-link"
                        href="https://www.genevievemendoza.com/about/"
                        >about</a
                    >
                </li>
            </menu>
        </nav>
    </div>
</header>

        <section class="section">
            <div class="blog-container">
<h1 class="title">My first post</h1>
<p class="subtitle"><strong>2019-11-27</strong></p>
<p>This is my first blog post.</p>
<p>Mocking an async context manager, eg for <code>aiohttp</code>:</p>
<p>What we need to mock:</p>
<ul>
<li>aiohttp.ClientSession: this can be treated as a dummy object, it just needs a <code>post</code> method. Mock</li>
<li>The <code>session.post</code> <em>synchronous</em> method. returns a class implementing the async context manager protocol. Mock</li>
<li>the async context manager (ACM) class returned by <code>session.post</code>. again a Mock</li>
<li>The <code>__aenter__</code> method of the context manager. a real async method that returns AsyncMock</li>
<li>The actual response object returned by ACM's <code>__aenter__</code> async method (named <code>as response</code>). AsyncMock</li>
<li>The <code>__aexit__</code> async method of the ACM. must return None to not suppress the exception
the default return_value of a Mock is a truthy MagicMock
if aexit returns something truthy, the exception is suppressed</li>
<li>The <code>.text()</code> method of the response object. AsyncMock</li>
</ul>
<pre data-lang="py" class="language-py z-code"><code class="language-py" data-lang="py"><span class="z-source z-python"><span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pytest</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">fixture</span></span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">mock_session</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-&gt;</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">AsyncMock</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">&quot;&quot;&quot;</span>A mock for aiohttp.ClientSession.<span class="z-punctuation z-definition z-comment z-end z-python">&quot;&quot;&quot;</span></span>
</span><span class="z-source z-python">    <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">AsyncMock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">spec</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">aiohttp</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">ClientSession</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pytest</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">fixture</span></span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">mock_response</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-&gt;</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">AsyncMock</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-comment z-block z-documentation z-python"><span class="z-punctuation z-definition z-comment z-begin z-python">&quot;&quot;&quot;</span>A mock for aiohttp.ClientResponse.<span class="z-punctuation z-definition z-comment z-end z-python">&quot;&quot;&quot;</span></span>
</span><span class="z-source z-python">    <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">AsyncMock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">spec</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">aiohttp</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">ClientResponse</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mock aiohttp.ClientResponse returned by __aenter__ method
</span></span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> of the async context manager returned by post()
</span></span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_response</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">status</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">HTTPStatus</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-variable z-other z-constant z-python">OK</span></span>
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_response</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">text</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">AsyncMock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">return_value</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">json</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">dumps</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_oxylabs_response</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Mock for aiohttp.ClientSession.post that correctly handles the async context manager.
</span></span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> A mock_response will be returned by `async with ... as response`
</span></span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_context_manager</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Mock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_context_manager</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-support z-function z-magic z-python">__aenter__</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">AsyncMock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">return_value</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_response</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_context_manager</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-support z-function z-magic z-python">__aexit__</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">AsyncMock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">return_value</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-constant z-language z-python">None</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_session</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">post</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Mock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">return_value</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_context_manager</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre>
<p>Similar to</p>
<pre data-lang="py" class="language-py z-code"><code class="language-py" data-lang="py"><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">asyncio</span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">contextlib</span></span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> can either define it ourselves
</span></span><span class="z-source z-python"><span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">contextlib</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-python"><span class="z-meta z-generic-name z-python">asynccontextmanager</span></span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">mock_async_context_manager</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-statement z-exception z-try z-python"><span class="z-keyword z-control z-exception z-try z-python">try</span><span class="z-punctuation z-section z-block z-exception z-try z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-yield z-python">yield</span>
</span><span class="z-source z-python">    <span class="z-meta z-statement z-exception z-finally z-python"><span class="z-keyword z-control z-exception z-finally z-python">finally</span><span class="z-punctuation z-section z-block z-exception z-finally z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-pass z-python">pass</span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> or use mocks
</span></span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">mock_acm_factory</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Mock</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-variable z-parameter z-python">return_value</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">mock_async_context_manager</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-modifier z-async z-python">async</span> <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">test_mock_async_context_manager</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-statement z-with z-python"><span class="z-storage z-modifier z-async z-python">async </span><span class="z-keyword z-control z-flow z-with z-python">with</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">mock_async_context_manager</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-block z-with z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-pass z-python">pass</span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">asyncio</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">run</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">test_mock_async_context_manager</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre>
<p>There we go.</p>
<p>Is this the most interesting thing I hope to write about? Certainly not. But it was something recent and easy enough to write about that I could use it to motivate myself to get this site and blog officially up and running.</p>
<p>Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet.
Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet.
Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet.
Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet.
Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet. Lorem ipsum dolor emet.</p>
 </div>
        </section>
        <!-- limit on only the homepage. is there a better way? -->
        
    </body>
</html>
